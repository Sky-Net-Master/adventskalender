<!-- Adventskalender v2.9 -->
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Adventskalender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: light dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      /* Hintergrundbild: bitte background.png ins Repo legen */
      background: #041624 url("background.png") center top / cover no-repeat fixed;
      transition: background 0.4s ease;
    }

    .snow-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      /* mehrere Ebenen von grÃ¶ÃŸeren Schneeflocken fÃ¼r einen deutlich sichtbaren Effekt */
      background-image:
        radial-gradient(4px 4px at 10px 10px, rgba(255,255,255,0.95) 50%, transparent 52%),
        radial-gradient(5px 5px at 60px 90px, rgba(255,255,255,0.9) 50%, transparent 52%),
        radial-gradient(6px 6px at 140px 40px, rgba(255,255,255,0.95) 50%, transparent 52%),
        radial-gradient(3px 3px at 200px 160px, rgba(255,255,255,0.9) 50%, transparent 52%);
      background-size: 200px 280px, 240px 340px, 280px 380px, 220px 320px;
      animation: snowDrift 24s linear infinite;
      opacity: 1;
    }

    @keyframes snowDrift {
      0% {
        background-position: 0px 0px, 0px 0px, 0px 0px;
      }
      100% {
        background-position: 0px 480px, -80px 540px, 80px 600px;
      }
    }


    .app {
      width: min(680px, 84vw);
      /* fast durchsichtig, nur ein Hauch WeiÃŸ fÃ¼r Lesbarkeit */
      background: rgba(255,255,255,0.04);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      border-radius: 18px;
      padding: 16px 16px 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0);
      position: relative;
      z-index: 1;
      transform-origin: center;
      transition:
        transform 0.35s ease,
        background 0.25s ease,
        box-shadow 0.25s ease;
    }

    .calendar-wrapper {
      margin-top: 8px;
      transition: opacity 0.25s ease, max-height 0.3s ease, transform 0.25s ease;
      max-height: 1200px; /* ausreichend Platz fÃ¼r den gesamten Kalender */
    }

    /* Modus: Mini (mehr Hintergrund sichtbar) */
    body.mode-mini .app {
      transform: translateY(10vh) scale(0.78);
      background: rgba(255,255,255,0.02);
      box-shadow: 0 10px 24px rgba(0,0,0,0.22);
    }

    /* Modus: Voll (Kalender im Fokus zum TÃ¼rchen Ã¶ffnen) */
    body.mode-full .app {
      transform: translateY(0) scale(1.0);
      background: rgba(255,255,255,0.08);
      box-shadow: 0 18px 40px rgba(0,0,0,0.28);
    }

    /* ZustÃ¤nde: Intro blendet Header & Kalender aus, View-Background blendet nur den KalenderkÃ¶rper aus */
    body.state-intro .app header,
    body.state-intro .app #calendar-wrapper,
    body.state-intro .app #version-info,
    body.state-intro .app #admin-info {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    body.view-background #calendar-wrapper {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.96);
      max-height: 0;
      overflow: hidden;
    }

    body.view-calendar #calendar-wrapper {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1.0);
      max-height: 1200px;
    }

    header {
      margin-bottom: 12px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.6rem, 3vw, 2.1rem);
      font-weight: 800;
      letter-spacing: 0.04em;
      color: #b71c1c;
      text-shadow:
        0 0 6px rgba(255,255,255,0.9),
        0 0 14px rgba(183,28,28,0.8);
    }

      header p {
        margin: 4px 0 0;
        font-size: 0.9rem;
        color: #f5f5f5;
        text-shadow: 0 0 4px rgba(0,0,0,0.75);
      }
      
      .loot-container {
        margin-top: 8px;
        display: flex;
        justify-content: center;
      }

      .loot-box {
        position: relative;
        min-width: 70%;
        padding: 8px 16px;
        border-radius: 12px;
        background: linear-gradient(145deg, #ffecb3, #f9a825 40%, #ffeb3b 60%, #f57f17);
        box-shadow:
          0 6px 14px rgba(0,0,0,0.4),
          inset 0 1px 0 rgba(255,255,255,0.9);
        border: 1px solid rgba(255,255,255,0.9);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 700;
        color: #3e2723;
        text-shadow: 0 0 3px rgba(255,255,255,0.6);
        transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      }

      .loot-box::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(255,255,255,0.8), transparent 40%, transparent 100%);
        mix-blend-mode: screen;
        opacity: 0.9;
        pointer-events: none;
      }

      .loot-box:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 14px rgba(0,0,0,0.3);
      }

      .loot-label {
        opacity: 0.9;
        font-weight: 600;
      }

      .loot-amount {
        font-size: 1.1rem;
        font-weight: 800;
      }

    .grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
    }

    @media (max-width: 800px) {
      .grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 540px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }
      .app {
        width: 82vw;
        padding: 10px 10px 12px;
      }
      body.mode-mini .app {
        transform: translateY(9vh) scale(0.82);
      }
      body.mode-full .app {
        transform: translateY(2vh) scale(0.96);
      }
      .door {
        padding-top: 72%;
      }
    }

    .door {
      position: relative;
      padding-top: 80%;
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      /* stÃ¤rker grÃ¼ner, weihnachtlicher Verlauf mit Glanzrahmen */
      background:
        linear-gradient(145deg, rgba(255,255,255,0.45), rgba(255,255,255,0.0)) border-box,
        linear-gradient(135deg, #00695c, #b71c1c);
      background-clip: padding-box, border-box;
      border: 2px solid rgba(255,255,255,0.85);
      color: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.22);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s;
    }

    .door-content {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px;
      text-align: center;
    }

    .door-number {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .door-amount {
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0;
      transform: translateY(4px);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .door-open .door-amount {
      opacity: 1;
      transform: translateY(0);
    }

    .door-open {
      background:
        linear-gradient(145deg, rgba(255,255,255,0.6), rgba(255,255,255,0.0)) border-box,
        linear-gradient(135deg, #f9a825, #2e7d32);
      background-clip: padding-box, border-box;
      border-color: rgba(255,255,255,0.95);
      color: #fffde7;
    }

    .door-locked {
      /* optisch wie eine normale, noch geschlossene TÃ¼r */
      cursor: not-allowed; /* weiterhin nicht klickbar, wenn in der Zukunft */
    }

    .door:hover:not(.door-locked) {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
    }

    body.mode-full .door {
      box-shadow: 0 10px 22px rgba(0,0,0,0.3);
    }

    body.mode-full .door-open {
      box-shadow: 0 12px 26px rgba(0,0,0,0.35);
    }

    .door-today:not(.door-open):not(.door-locked) {
      animation: doorPulse 1.6s ease-in-out infinite;
    }

    @keyframes doorPulse {
      0% {
        transform: translateY(0) scale(1);
        box-shadow: 0 6px 14px rgba(0,0,0,0.2);
      }
      100% {
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 12px 22px rgba(0,0,0,0.35);
      }
    }

    /* ZufÃ¤llige Effekte beim Ã–ffnen */
    .door-effect-glow {
      animation: doorEffectGlow 1.2s ease-out 1;
    }

    @keyframes doorEffectGlow {
      0% {
        box-shadow: 0 0 0 rgba(255,215,0,0.0);
        transform: scale(1);
      }
      30% {
        box-shadow: 0 0 22px rgba(255,215,0,0.9), 0 0 40px rgba(255,255,255,0.7);
        transform: scale(1.05);
      }
      70% {
        box-shadow: 0 0 18px rgba(255,215,0,0.7), 0 0 30px rgba(255,255,255,0.5);
        transform: scale(1.03);
      }
      100% {
        box-shadow: 0 6px 14px rgba(0,0,0,0.2);
        transform: scale(1.0);
      }
    }

    .door-effect-bounce {
      animation: doorEffectBounce 0.8s ease-out 1;
    }

    @keyframes doorEffectBounce {
      0%   { transform: translateY(0) scale(1); }
      30%  { transform: translateY(-6px) scale(1.03); }
      55%  { transform: translateY(3px) scale(0.99); }
      75%  { transform: translateY(-3px) scale(1.01); }
      100% { transform: translateY(0) scale(1); }
    }

    .door-effect-twinkle {
      position: relative;
      overflow: visible;
    }

    .door-effect-twinkle::after {
      content: "âœ¨";
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 1.4rem;
      animation: doorEffectTwinkle 1s ease-out 1;
      pointer-events: none;
    }

    @keyframes doorEffectTwinkle {
      0%   { opacity: 0; transform: scale(0.5) rotate(-20deg); }
      30%  { opacity: 1; transform: scale(1.1) rotate(0deg); }
      70%  { opacity: 1; transform: scale(1.0) rotate(10deg); }
      100% { opacity: 0; transform: scale(0.8) rotate(20deg); }
    }

    .date-info {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #444;
      text-align: center;
    }

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(0,0,0,0.35), rgba(0,0,0,0.7));
      z-index: 2;
    }

    .overlay-inner {
      background: rgba(15, 20, 35, 0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px 18px 18px;
      width: min(360px, 88vw);
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      text-align: center;
      transform: scale(0.9);
      animation: overlayPop 0.25s ease-out forwards;
      color: #f5f5f5;
      border: 1px solid rgba(255,255,255,0.55);
    }

    .overlay-title span:nth-child(4n+1) { color: #d32f2f; }
    .overlay-title span:nth-child(4n+2) { color: #2e7d32; }
    .overlay-title span:nth-child(4n+3) { color: #f9a825; }
    .overlay-title span:nth-child(4n+4) { color: #795548; }

    .overlay-santa {
      font-size: 2.6rem;
      margin-bottom: 8px;
    }

    .overlay-text p {
      margin: 4px 0;
    }

    #overlay-day {
      font-weight: 600;
    }

    #overlay-amount {
      font-size: 1.4rem;
      font-weight: 700;
      margin-top: 6px;
    }

    #overlay-confirm,
    #intro-confirm {
      margin-top: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: linear-gradient(135deg,#0bab64,#3bb78f);
      color:#fff;
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }

    #overlay-confirm:active,
    #intro-confirm:active {
      transform: translateY(1px);
    }

    @keyframes overlayPop {
      from { opacity:0; transform: scale(0.9); }
      to { opacity:1; transform: scale(1); }
    }
  </style>
</head>
<body>

<button id="reload-btn" style="position:fixed; top:10px; left:10px; z-index:5; padding:6px 10px; border:none; border-radius:8px; background:rgba(255,255,255,0.6); backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px); font-size:0.8rem; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2);">
  ðŸ”„ Neu laden
</button>

<div class="snow-layer"></div>

<div class="app">
    <header>
      <h1 id="calendar-title">Adventskalender</h1>
      <p id="calendar-subtitle"></p>
      <div class="loot-container">
        <button id="loot-box" class="loot-box" type="button">
          <span class="loot-icon">ðŸ’°</span>
          <span class="loot-label">Deine Beute:</span>
          <span class="loot-amount" id="loot-amount">0,00 â‚¬</span>
        </button>
      </div>
    </header>

</header>

  <div id="calendar-wrapper" class="calendar-wrapper">
    <div class="grid" id="calendar-grid">
      <!-- TÃ¼ren werden durch JS eingefÃ¼gt -->
    </div>
    <div class="date-info" id="date-info"></div>
  </div>
  <div class="date-info" id="version-info"></div>
  <div class="date-info" id="admin-info"></div>
</div>

<!-- Intro-Overlay: Weihnachtswunderland -->
<div id="intro-overlay" class="overlay" aria-hidden="true">
  <div class="overlay-inner">
    <div class="overlay-santa">ðŸ§šðŸŽ„âœ¨ðŸ’« ðŸŒ²</div>
    <div class="overlay-text">
      <p id="intro-title" class="overlay-title">Willkommen im Weihnachtswunderland</p>
      <p id="intro-message"></p>
    </div>
    <button id="intro-confirm" type="button">Zum Kalender</button>
  </div>
</div>

<!-- Usability-Overlay: ErklÃ¤rung der neuen Bedienung (nur 1x pro Kalender am 05.12.) -->
<div id="usability-overlay" class="overlay" aria-hidden="true">
  <div class="overlay-inner">
    <div class="overlay-santa">ðŸ’¡ðŸŽ„âœ¨</div>
    <div class="overlay-text">
      <p id="usability-title" class="overlay-title">Neu: Dein Weihnachtswunderland-Update</p>
      <p id="usability-message"></p>
    </div>
    <button id="usability-confirm" type="button">Los geht's</button>
  </div>
</div>

<!-- TÃ¼rchen-Overlay -->
<div id="door-overlay" class="overlay" aria-hidden="true">
  <div class="overlay-inner">
    <div class="overlay-santa">ðŸŽ„ðŸ’¸ðŸŽ„ðŸ¤‘ðŸŽ„ðŸ’¶ðŸŽ„</div>
    <div class="overlay-text">
      <p id="overlay-title" class="overlay-title">Heute ist dein Advents-Ãœberraschungstag</p>
      <p id="overlay-day"></p>
      <p id="overlay-amount"></p>
    </div>
    <button id="overlay-confirm" type="button">Zum Kalender</button>
  </div>
</div>

<script>
  /******************************************************
   * KONFIGURATION
   ******************************************************/

  const APP_VERSION = "SkyNet Adventskalender v2.9 â€“ by OPI-Soft";

  const UNIT_CENTS = 50; // 0,50 â‚¬ pro Einheit

  const CALENDARS = {
    "1": {
      id: "1",
      name: "Gloria",
      totalEuro: 150.0,
      day6RangeEuro: { min: 4.0, max: 8.0 },
      day24RangeEuro: { min: 90.0, max: 110.0 }
    },
    "2": {
      id: "2",
      name: "Larissa",
      totalEuro: 30.0,
      day6RangeEuro: { min: 3.0, max: 4.5 },
      day24RangeEuro: { min: 7.0, max: 10.0 }
    },
    "3": {
      id: "3",
      name: "Vanessa",
      totalEuro: 30.0,
      day6RangeEuro: { min: 3.0, max: 4.5 },
      day24RangeEuro: { min: 7.0, max: 10.0 }
    }
  };

  const DAYS_TOTAL = 24;
  const DAY6 = 6;
  const DAY24 = 24;

  /******************************************************
   * HILFSFUNKTIONEN
   ******************************************************/

  function getQueryParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  const ADMIN_MODE = getQueryParam("admin") === "1";

  function formatEuro(cents) {
    const euros = (cents / 100).toFixed(2).replace(".", ",");
    return euros + " â‚¬";
  }

  function randomIntInclusive(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      const tmp = arr[i];
      arr[i] = arr[j];
      arr[j] = tmp;
    }
  }

  function getTodayInfo() {
    const now = new Date();
    return {
      year: now.getFullYear(),
      month: now.getMonth(),
      day: now.getDate()
    };
  }

  function isDoorUnlocked(doorDay) {
    const { month, day } = getTodayInfo();
    if (month !== 11) return false; // nur Dezember
    return day >= doorDay;
  }

  /******************************************************
   * VERTEILLOGIK
   ******************************************************/

  function euroRangeToUnitRange(rangeEuro) {
    const minUnits = Math.round(rangeEuro.min * 100 / UNIT_CENTS);
    const maxUnits = Math.round(rangeEuro.max * 100 / UNIT_CENTS);
    return { minUnits, maxUnits };
  }

  function generateAmountsForCalendar(calConfig) {
    const totalCents = Math.round(calConfig.totalEuro * 100);
    const totalUnits = totalCents / UNIT_CENTS;

    const { minUnits: day6Min, maxUnits: day6Max } = euroRangeToUnitRange(calConfig.day6RangeEuro);
    const { minUnits: day24Min, maxUnits: day24Max } = euroRangeToUnitRange(calConfig.day24RangeEuro);

    const normalDays = [];
    for (let d = 1; d <= DAYS_TOTAL; d++) {
      if (d !== DAY6 && d !== DAY24) normalDays.push(d);
    }
    const normalsCount = normalDays.length;

    const unitsPerDay = new Array(DAYS_TOTAL + 1).fill(0);

    let u6, u24;
    const maxTries = 1000;
    let tries = 0;
    while (true) {
      tries++;
      u6 = randomIntInclusive(day6Min, day6Max);
      u24 = randomIntInclusive(day24Min, day24Max);

      const specials = u6 + u24;
      const minNeededForNormals = normalsCount;
      if (specials + minNeededForNormals <= totalUnits) {
        break;
      }
      if (tries > maxTries) {
        console.warn("Konnte keine gÃ¼ltigen Specials finden, fallback.");
        u6 = day6Min;
        u24 = day24Min;
        break;
      }
    }

    unitsPerDay[DAY6] = u6;
    unitsPerDay[DAY24] = u24;

    let remainingUnits = totalUnits - (u6 + u24);

    for (const d of normalDays) {
      unitsPerDay[d] = 1;
      remainingUnits -= 1;
    }

    while (remainingUnits > 0) {
      const idx = randomIntInclusive(0, normalDays.length - 1);
      const day = normalDays[idx];
      unitsPerDay[day] += 1;
      remainingUnits -= 1;
    }

    const amountsCents = [];
    for (let d = 1; d <= DAYS_TOTAL; d++) {
      amountsCents.push(unitsPerDay[d] * UNIT_CENTS);
    }

    const sumCheck = amountsCents.reduce((a, b) => a + b, 0);
    if (sumCheck !== totalCents) {
      console.warn("Summe stimmt nicht!", sumCheck, "â‰ ", totalCents);
    }

    return amountsCents;
  }

  /******************************************************
   * STORAGE
   ******************************************************/

  function storageKeysForCalendar(calId) {
    const prefix = "advent_v1_kal" + calId + "_";
    return {
      amounts: prefix + "amounts_cents",
      opened: prefix + "opened"
    };
  }

  function loadOrCreateData(calConfig) {
    const keys = storageKeysForCalendar(calConfig.id);

    let amounts = null;
    let opened = null;

    try {
      const a = localStorage.getItem(keys.amounts);
      if (a) {
        const parsed = JSON.parse(a);
        if (Array.isArray(parsed) && parsed.length === DAYS_TOTAL) {
          amounts = parsed;
        }
      }
    } catch (e) {
      console.warn("Fehler beim Lesen amounts:", e);
    }

    try {
      const o = localStorage.getItem(keys.opened);
      if (o) {
        const parsed = JSON.parse(o);
        if (Array.isArray(parsed) && parsed.length === DAYS_TOTAL) {
          opened = parsed.map(Boolean);
        }
      }
    } catch (e) {
      console.warn("Fehler beim Lesen opened:", e);
    }

    if (!amounts) {
      amounts = generateAmountsForCalendar(calConfig);
      try {
        localStorage.setItem(keys.amounts, JSON.stringify(amounts));
      } catch (e) {
        console.warn("Fehler beim Schreiben amounts:", e);
      }
    }

    if (!opened) {
      opened = new Array(DAYS_TOTAL).fill(false);
      try {
        localStorage.setItem(keys.opened, JSON.stringify(opened));
      } catch (e) {
        console.warn("Fehler beim Schreiben opened:", e);
      }
    }

    return { amounts, opened, keys };
  }

  function saveOpened(keys, opened) {
    try {
      localStorage.setItem(keys.opened, JSON.stringify(opened));
    } catch (e) {
      console.warn("Fehler beim Schreiben opened:", e);
    }
  }
  function adminResetAll() {
    try {
      for (let i = localStorage.length - 1; i >= 0; i--) {
        const key = localStorage.key(i);
        if (key && key.startsWith("advent_v1_")) {
          localStorage.removeItem(key);
        }
      }
      alert("Alle Adventskalender-Daten auf diesem GerÃ¤t wurden gelÃ¶scht.");
    } catch (e) {
      console.warn("Admin-Reset fehlgeschlagen:", e);
      alert("Admin-Reset fehlgeschlagen (siehe Konsole).");
    }
  }

  /******************************************************
   * OVERLAYS
   ******************************************************/

  const overlay = document.getElementById("door-overlay");
  const overlayDay = document.getElementById("overlay-day");
  const overlayAmount = document.getElementById("overlay-amount");
  const overlayConfirm = document.getElementById("overlay-confirm");
  const overlayTitle = document.getElementById("overlay-title");

  const introOverlay = document.getElementById("intro-overlay");
  const introTitle = document.getElementById("intro-title");
  const introMessage = document.getElementById("intro-message");
  const introConfirm = document.getElementById("intro-confirm");

  const usabilityOverlay = document.getElementById("usability-overlay");
  const usabilityTitle = document.getElementById("usability-title");
  const usabilityMessage = document.getElementById("usability-message");
  const usabilityConfirm = document.getElementById("usability-confirm");
  function showUsabilityHintIfNeeded(calConfig, data) {
    if (!usabilityOverlay || !usabilityConfirm || !usabilityMessage) return false;

    const { year, month, day } = getTodayInfo();

    // Nur am 05.12. im Dezember
    if (!(month === 11 && day === 5)) {
      return false;
    }

    // Pro Kalender und Tag nur einmal anzeigen
    const mm = String(month + 1).padStart(2, "0");
    const dd = String(day).padStart(2, "0");
    const usabilityKey = "advent_v1_kal" + calConfig.id + "_usability_" + year + "-" + mm + "-" + dd;

    try {
      const val = localStorage.getItem(usabilityKey);
      if (val === "1") {
        return false;
      }
    } catch (e) {
      console.warn("Fehler beim Lesen usability-Key:", e);
    }

    if (usabilityTitle) {
      usabilityTitle.textContent = "Neu: Dein Weihnachtswunderland-Update";
    }

    usabilityMessage.textContent =
      "ðŸ³ Ab heute kannst du mit einem Tipp auf den Goldbarren deinen Kalender ein- und ausblenden. ðŸ¤© " +
      "Nach dem Ã–ffnen eines TÃ¼rchens rÃ¼ckt das Weihnachtsbild wieder in den Vordergrund.            ðŸ“¸ BildvorschlÃ¤ge Ã¼ber WahtsApp an Franco ðŸ’« ";

    // WÃ¤hrend des Hinweises Header & Kalender ausblenden
    document.body.classList.add("state-intro");

    usabilityOverlay.style.display = "flex";
    usabilityOverlay.setAttribute("aria-hidden", "false");

    usabilityConfirm.onclick = () => {
      usabilityOverlay.style.display = "none";
      usabilityOverlay.setAttribute("aria-hidden", "true");

      // Merken, dass der Hinweis heute bereits gezeigt wurde
      try {
        localStorage.setItem(usabilityKey, "1");
      } catch (e) {
        console.warn("Fehler beim Schreiben usability-Key:", e);
      }

      // Hinweis-Zustand verlassen und wie gewohnt fortfahren
      document.body.classList.remove("state-intro");

      // Im Anschluss ganz normal das Intro versuchen
      const introShown = showIntroIfNeeded(calConfig, data);
      if (!introShown) {
        // Falls kein Intro nÃ¶tig, gleich in den normalen Kalenderzustand wechseln
        document.body.classList.remove("view-background");
        document.body.classList.add("view-calendar");
        document.body.classList.remove("mode-mini");
        document.body.classList.add("mode-full");
      }
    };

    return true;
  }

  function colorizeOverlayTitle() {
    if (!overlayTitle) return;
    const text = overlayTitle.textContent || "";
    overlayTitle.textContent = "";
    for (const ch of text) {
      const span = document.createElement("span");
      span.textContent = ch;
      overlayTitle.appendChild(span);
    }
  }

  function showDoorOverlay(dayNumber, amountCents, onConfirm) {
    if (!overlay || !overlayDay || !overlayAmount || !overlayConfirm) {
      onConfirm();
      return;
    }
    overlayDay.textContent = "TÃ¼rchen " + dayNumber;
    overlayAmount.textContent = formatEuro(amountCents);
    overlayConfirm.onclick = () => {
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden","true");
      onConfirm();
    };
    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden","false");
  }

  function applyRandomDoorEffect(door) {
    const effects = ["door-effect-glow", "door-effect-bounce", "door-effect-twinkle"];
    const effectClass = effects[Math.floor(Math.random() * effects.length)];
    door.classList.add(effectClass);
    setTimeout(() => {
      door.classList.remove(effectClass);
    }, 1300);
  }

  function showIntroIfNeeded(calConfig, data) {
    if (!introOverlay || !introConfirm || !introMessage) return false;

    const todayInfo = getTodayInfo();
    const { year, month, day } = todayInfo;

    // Nur im Advent (1.â€“24. Dezember)
    if (month !== 11 || day < 1 || day > 24) {
      return false;
    }

    const todayIndex = day - 1;
    const alreadyOpened = data.opened && data.opened[todayIndex];

    // Wenn das heutige TÃ¼rchen bereits geÃ¶ffnet ist, kein Intro mehr anzeigen
    if (alreadyOpened) {
      return false;
    }

    // Intro nur einmal pro Tag und Kalender anzeigen
    const mm = String(month + 1).padStart(2, "0");
    const dd = String(day).padStart(2, "0");
    const introKey = "advent_v1_kal" + calConfig.id + "_intro_" + year + "-" + mm + "-" + dd;

    try {
      const val = localStorage.getItem(introKey);
      if (val === "1") {
        // Intro fÃ¼r diesen Tag und Kalender wurde bereits angezeigt
        return false;
      }
    } catch (e) {
      console.warn("Fehler beim Lesen intro-Key:", e);
    }

    if (introTitle) {
      introTitle.textContent = calConfig.name + "s Weihnachtswunderland";
    }

    introMessage.textContent =
      "Heute wartet TÃ¼rchen " + day + " auf dich. Such es im Kalender und tippe darauf, um deine Ãœberraschung zu sehen!";

    // WÃ¤hrend des Intros Header & Kalender ausblenden
    document.body.classList.add("state-intro");

    introOverlay.style.display = "flex";
    introOverlay.setAttribute("aria-hidden", "false");

    introConfirm.onclick = () => {
      introOverlay.style.display = "none";
      introOverlay.setAttribute("aria-hidden", "true");

      // Merken, dass das Intro heute bereits gezeigt wurde
      try {
        localStorage.setItem(introKey, "1");
      } catch (e) {
        console.warn("Fehler beim Schreiben intro-Key:", e);
      }

      // Intro-Zustand verlassen, Kalender sichtbar machen und Misch-Animation starten
      document.body.classList.remove("state-intro");
      document.body.classList.remove("view-background");
      document.body.classList.add("view-calendar");
      document.body.classList.remove("mode-mini");
      document.body.classList.add("mode-full");

      mixCalendar(calConfig, data, 3);
    };

    return true;
  }

  /******************************************************
   * UI
   ******************************************************/

  function mixCalendar(calConfig, data, times = 3) {
    let count = 0;
    function step() {
      buildCalendar(calConfig, data);
      document.body.classList.remove("view-background");
      document.body.classList.add("view-calendar");
      count++;
      if (count < times) {
        setTimeout(step, 220);
      }
    }
    // leichter Delay, damit das Intro-Ausblenden optisch sauber ist
    setTimeout(step, 280);
  }

    function buildCalendar(calConfig, data) {
      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";

      const title = document.getElementById("calendar-title");
      const subtitle = document.getElementById("calendar-subtitle");
      const dateInfo = document.getElementById("date-info");
      const lootBox = document.getElementById("loot-box");
      const lootAmountEl = document.getElementById("loot-amount");

      title.textContent = calConfig.name + "s Adventskalender";

      const { year, month, day } = getTodayInfo();
      dateInfo.textContent =
        "Heute ist der " +
        String(day).padStart(2, "0") + "." +
        String(month + 1).padStart(2, "0") + "." +
        year;

      subtitle.textContent = "FÃ¼r " + calConfig.name + " â€“ dein persÃ¶nlicher Adventskalender.";

      // Beute-Summe berechnen (Summe aller geÃ¶ffneten TÃ¼rchen)
      function updateLootDisplay() {
        if (!lootAmountEl) return;
        let totalOpenedCents = 0;
        for (let d = 1; d <= DAYS_TOTAL; d++) {
          const idx = d - 1;
          if (data.opened[idx]) {
            totalOpenedCents += data.amounts[idx];
          }
        }
        lootAmountEl.textContent = formatEuro(totalOpenedCents);
      }

      // Initial anzeigen
      updateLootDisplay();

      // Klick auf die Beute: Kalender ein-/ausblenden (Hintergrund vs. Kalender-Ansicht)
      if (lootBox) {
        lootBox.onclick = () => {
          if (document.body.classList.contains("view-calendar")) {
            document.body.classList.remove("view-calendar");
            document.body.classList.add("view-background");
          } else {
            document.body.classList.remove("view-background");
            document.body.classList.add("view-calendar");
          }
        };
      }

      const today = { year, month, day };

    const order = [];
    for (let d = 1; d <= DAYS_TOTAL; d++) {
      order.push(d);
    }
    shuffleArray(order);

    for (let i = 0; i < DAYS_TOTAL; i++) {
      const dayNumber = order[i];
      const dataIndex = dayNumber - 1;

      const amountCents = data.amounts[dataIndex];
      const isOpened = data.opened[dataIndex];
      const unlocked = isDoorUnlocked(dayNumber);

      const door = document.createElement("div");
      door.className = "door";

      if (!unlocked) {
        door.classList.add("door-locked");
      }
      if (isOpened) {
        door.classList.add("door-open");
      }
      if (today.month === 11 && today.day === dayNumber && unlocked && !isOpened) {
        door.classList.add("door-today");
      }

      const content = document.createElement("div");
      content.className = "door-content";

      const numEl = document.createElement("div");
      numEl.className = "door-number";
      numEl.textContent = dayNumber;

      const amountEl = document.createElement("div");
      amountEl.className = "door-amount";
      amountEl.textContent = formatEuro(amountCents);

      content.appendChild(numEl);
      content.appendChild(amountEl);
      door.appendChild(content);
      grid.appendChild(door);

      door.addEventListener("click", () => {
        const nowUnlocked = isDoorUnlocked(dayNumber);
        if (!nowUnlocked) {
          alert("Dieses TÃ¼rchen ist noch verschlossen.");
          return;
        }

        if (data.opened[dataIndex]) {
          return;
        }

        showDoorOverlay(dayNumber, amountCents, () => {
          data.opened[dataIndex] = true;
          saveOpened(data.keys, data.opened);
          door.classList.add("door-open");
          applyRandomDoorEffect(door);
          updateLootDisplay();
          // Nach dem Ã–ffnen etwas zurÃ¼cktreten: Kalender in den Mini-Modus und Hintergrund-Ansicht
          document.body.classList.remove("mode-full");
          document.body.classList.add("mode-mini");
          document.body.classList.remove("view-calendar");
          document.body.classList.add("view-background");
        });
      });
    }
  }

  /******************************************************
   * INIT
   ******************************************************/

  const reloadBtn = document.getElementById("reload-btn");
  if (reloadBtn) {
    reloadBtn.addEventListener("click", () => {
      location.reload();
    });
  }
  (function init() {
    colorizeOverlayTitle();

    document.body.classList.add("mode-mini");
    document.body.classList.add("view-background");

    const versionInfo = document.getElementById("version-info");
    if (versionInfo) {
      versionInfo.textContent = APP_VERSION;
    }

    const adminInfo = document.getElementById("admin-info");
    if (adminInfo && ADMIN_MODE) {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "Admin: GerÃ¤t zurÃ¼cksetzen";
      btn.style.border = "none";
      btn.style.borderRadius = "999px";
      btn.style.padding = "4px 10px";
      btn.style.fontSize = "0.75rem";
      btn.style.cursor = "pointer";
      btn.style.background = "#c62828";
      btn.style.color = "#fff";
      btn.style.boxShadow = "0 2px 6px rgba(0,0,0,0.25)";
      btn.addEventListener("click", () => {
        if (confirm("Wirklich alle Adventskalender-Daten auf DIESEM GerÃ¤t lÃ¶schen?")) {
          adminResetAll();
        }
      });
      adminInfo.textContent = "";
      adminInfo.appendChild(btn);
    } else if (adminInfo) {
      adminInfo.textContent = "";
    }

    let kal = getQueryParam("kal");

    const title = document.getElementById("calendar-title");
    const subtitle = document.getElementById("calendar-subtitle");
    const dateInfo = document.getElementById("date-info");
    const grid = document.getElementById("calendar-grid");

    if (!kal || !CALENDARS[kal]) {
      const { year, month, day } = getTodayInfo();

      if (title) {
        title.textContent = "Adventskalender";
      }
      if (subtitle) {
        subtitle.textContent = "Diese Seite ist gesperrt. Bitte nutze deinen persÃ¶nlichen Link fÃ¼r Gloria, Larissa oder Vanessa.";
      }
      if (dateInfo) {
        dateInfo.textContent =
          "Aufruf am " +
          String(day).padStart(2, "0") + "." +
          String(month + 1).padStart(2, "0") + "." +
          year;
      }
      if (grid) {
        grid.innerHTML = "";
      }
      const lootContainer = document.querySelector(".loot-container");
      if (lootContainer) {
        lootContainer.style.display = "none";
      }
      return;
    }

    const calConfig = CALENDARS[kal];

    document.body.classList.add("theme-" + calConfig.id);

    const data = loadOrCreateData(calConfig);
    buildCalendar(calConfig, data);

    // Zuerst prÃ¼fen, ob wir am 05.12. den neuen Usability-Hinweis zeigen sollen
    const usabilityShown = showUsabilityHintIfNeeded(calConfig, data);

    if (!usabilityShown) {
      const introShown = showIntroIfNeeded(calConfig, data);

      if (!introShown) {
        // Kein Intro (z.B. nach dem ersten Aufruf des Tages oder auÃŸerhalb der Adventszeit):
        // Kalender im Fokus und sichtbar starten
        document.body.classList.remove("view-background");
        document.body.classList.add("view-calendar");
        document.body.classList.remove("mode-mini");
        document.body.classList.add("mode-full");
      }
    }

  })();
</script>
</body>
</html>
